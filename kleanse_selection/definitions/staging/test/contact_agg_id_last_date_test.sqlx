config {
  type: "test",
  dataset : "contact_agg_id_last_date"
  }
  input "contact_with_last_date" {
select "148364118"                          as rowid_object,
       date("2020-05-22") as create_date,
       "FR"                                 as code_pays,
       null                                 as flag_anonymous,
       "anthonydelplanque802@gmail.com"     as emails,
       "500034551420"                       as no_carte_fid,
       42178394                             as id_compte_fid,
       "1765790417"                         as id_compte_WEB,
       "1"                                  as code_type_compte,
       date("2022-09-10") as last_date_sales_fid,
       "N"                                  as personnel_kiabi,
       date(null)                      as last_date_creation_livre_bb,
       date("2022-09-11") as last_date_creation_cart_fid,
       date(null)                      as last_date_globalweborder_id_cpte,
       date(null)                      as last_date_weborder_fid,
       date(null)                      as last_date_weborder_id_cpte,
       date(null)               as last_date_clic_rowid
union all
select "148364118"                          as rowid_object,
       date("2020-05-22") as create_date,
       "FR"                                 as code_pays,
       null                                 as flag_anonymous,
       "anthonydelplanquepc80600@gmail.com" as emails,
       "500036894135"                       as no_carte_fid,
       43858143                             as id_compte_fid,
       " 1759245420"                        as id_compte_WEB,
       "1"                                  as code_type_compte,
       date(null)                      as last_date_sales_fid,
       "N"                                  as personnel_kiabi,
       date(null)                      as last_date_creation_livre_bb,
       date(null)                      as last_date_creation_cart_fid,
       date(null)                      as last_date_globalweborder_id_cpte,
       date(null)                      as last_date_weborder_fid,
       date(null)                      as last_date_weborder_id_cpte,
       date(null)               as last_date_clic_rowid

union all
select "54143177"                           as rowid_object,
       date("2015-12-03") as create_date,
       null                                 as code_pays,
       "N"                                  as flag_anonymous,
       "gwenlucass50400@outlook.fr"         as emails,
       "500002288921"                       as no_carte_fid,
       21865066                             as id_compte_fid,
       "1509135977"                         as id_compte_WEB,
       "1"                                  as code_type_compte,
       date("2018-01-11") as last_date_sales_fid,
       "N"                                  as personnel_kiabi,
       date("2021-10-29") as last_date_creation_livre_bb,
       date("2015-12-03") as last_date_creation_cart_fid,
       date(null)                      as last_date_globalweborder_id_cpte,
       date("2019-07-08") as last_date_weborder_fid,
       date("2017-12-30") as last_date_weborder_id_cpte,
       date(null)               as last_date_clic_rowid
union all
select "54143178"                           as rowid_object,
       date("2015-12-03") as create_date,
       null                                 as code_pays,
       "N"                                  as flag_anonymous,
       "gwenlucass50400@outlook.fr"         as emails,
       "500002288921"                       as no_carte_fid,
       21865066                             as id_compte_fid,
       "1509135977"                         as id_compte_WEB,
       "1"                                  as code_type_compte,
       date(null)                      as last_date_sales_fid,
       "N"                                  as personnel_kiabi,
       date(null)                      as last_date_creation_livre_bb,
       date(null)                      as last_date_creation_cart_fid,
       date(null)                      as last_date_globalweborder_id_cpte,
       date(null)                      as last_date_weborder_fid,
       date(null)                      as last_date_weborder_id_cpte,
       date(null)               as last_date_clic_rowid
union all
select "54143179"                   as rowid_object,
       date(null)              as create_date,
       null                         as code_pays,
       "N"                          as flag_anonymous,
       "gwenlucass50400@outlook.fr" as emails,
       "500002288921"               as no_carte_fid,
       21865066                     as id_compte_fid,
       "1509135977"                 as id_compte_WEB,
       "1"                          as code_type_compte,
       date(null)              as last_date_sales_fid,
       "N"                          as personnel_kiabi,
       date(null)              as last_date_creation_livre_bb,
       date(null)              as last_date_creation_cart_fid,
       date(null)              as last_date_globalweborder_id_cpte,
       date(null)              as last_date_weborder_fid,
       date(null)              as last_date_weborder_id_cpte,
       date(null)       as last_date_clic_rowid}
--rowid_object 148364118: VÃ©rifier la fusion correcte des duplicate rowids en une seule ligne
--rowid_object 54143177 : client avec plusieurs dates
--rowid_object 54143178 : contact avec dates d'achat nulles -> type_customer=prospect
--rowid_object 54143179: contact avec toutes les dates null -> type_customer=prospect

input "anonymisation_country_param" {
select "PROSPECT" as type_customer,
       "FR"       as country,
       36         as retention_periods,
       1095       as retention_period_days
union all
select "CLIENT" as type_customer,
       "FR"     as country,
       36       as retention_periods,
       1095       as retention_period_days }

select *
from (select "54143177"         as rowid_object,
             null               as code_pays,
             "N"                as flag_anonymous,
             "CLIENT"           as type_customer,
             date("2015-12-03") as contact_xref_create_date,
             date("2018-01-11") as last_date_sales_fid,
             "N"                as personnel_kiabi,
             date("2021-10-29") as last_date_creation_livre_bb,
             date("2015-12-03") as last_date_creation_cart_fid,
             null               as last_date_globalweborder_id_cpte,
             date("2019-07-08") as last_date_weborder_fid,
             date("2017-12-30") as last_date_weborder_id_cpte,
             date(null)         as last_date_clic_rowid,
             730                 as retention_periods,
             date("2021-10-29") as max_last_Date_rowid
      union all
      select "148364118"        as rowid_object,
             "FR"               as code_pays,
             null               as flag_anonymous,
             "CLIENT"           as type_customer,
             date("2020-05-22") as contact_xref_create_date,
             date("2022-09-10") as last_date_sales_fid,
             "N"                as personnel_kiabi,
             date(null)         as last_date_creation_livre_bb,
             date("2022-09-11") as last_date_creation_cart_fid,
             date(null)         as last_date_globalweborder_id_cpte,
             date(null)         as last_date_weborder_fid,
             date(null)         as last_date_weborder_id_cpte,
             date(null)         as last_date_clic_rowid,
             1095                 as retention_periods,
             date("2022-09-11") as max_last_Date_rowid
      union all
      select "54143178"         as rowid_object,
             null               as code_pays,
             "N"                as flag_anonymous,
             "PROSPECT"         as type_customer,
             date("2015-12-03") as contact_xref_create_date,
             date(null)         as last_date_sales_fid,
             "N"                as personnel_kiabi,
             date(null)         as last_date_creation_livre_bb,
             date(null)         as last_date_creation_cart_fid,
             date(null)         as last_date_globalweborder_id_cpte,
             date(null)         as last_date_weborder_fid,
             date(null)         as last_date_weborder_id_cpte,
             date(null)         as last_date_clic_rowid,
             730                 as retention_periods,
             date("2015-12-03") as max_last_Date_rowid
      union all
      select "54143179" as rowid_object,
             null       as code_pays,
             "N"        as flag_anonymous,
             "PROSPECT" as type_customer,
             date(null) as contact_xref_create_date,
             date(null) as last_date_sales_fid,
             "N"        as personnel_kiabi,
             date(null) as last_date_creation_livre_bb,
             date(null) as last_date_creation_cart_fid,
             date(null) as last_date_globalweborder_id_cpte,
             date(null) as last_date_weborder_fid,
             date(null) as last_date_weborder_id_cpte,
             date(null) as last_date_clic_rowid,
             730         as retention_periods,
             date(null) as max_last_Date_rowid)
order by rowid_object